'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

;(function (root, factory) {
	if (typeof define === 'function' && define.amd) {
		define([], factory(root));
	} else if ((typeof exports === 'undefined' ? 'undefined' : _typeof(exports)) === 'object') {
		module.exports = factory(root);
	} else {
		root.Select = factory(root);
	}
})(typeof global !== 'undefined' ? global : window || undefined.window || undefined.global, function (root) {
	'use strict';

	if (!Element.prototype.closest) {
		(function (ELEMENT) {
			ELEMENT.matches = ELEMENT.matches || ELEMENT.mozMatchesSelector || ELEMENT.msMatchesSelector || ELEMENT.oMatchesSelector || ELEMENT.webkitMatchesSelector;
			ELEMENT.closest = ELEMENT.closest || function closest(selector) {
				if (!this) return null;
				if (this.matches(selector)) return this;
				if (!this.parentElement) {
					return null;
				} else return this.parentElement.closest(selector);
			};
		})(Element.prototype);
	}

	window.Select = Select || {};

	var defaultClasses = {
		newSelectClass: 'select',
		buttonClass: 'select__title',
		textClass: 'select__text',
		iconClass: 'select__icon',
		listWrapperClass: 'select__inner',
		listClass: 'select__list',
		listItemClass: 'select__item',
		listItemSelectedClass: 'select__item--selected'
	};

	function Select(obj) {
		this.selectEl = obj.selector;
		this.callBack = obj.callBack;

		this.text = null;
		this.listWrapper = null;
		this.select = document.querySelector(this.selectEl);

		createNewSelect.apply(this, [this.selectEl, getSelectAttributes(this.selectEl), getOptionAttributes(this.selectEl)]);
		initClickEvent.call(this);
	}

	function getSelectAttributes(el) {
		return Array.prototype.slice.call(document.querySelector(el).attributes);
	}

	function getOptionAttributes(el) {
		return Array.prototype.slice.call(document.querySelector(el).children).map(function (item) {
			return Array.prototype.slice.call(item.attributes);
		});
	}

	function getOptionInnerText(el) {
		return Array.prototype.slice.call(document.querySelector(el).children).map(function (item) {
			return item.textContent;
		});
	}

	function hideSelectEl(el) {
		document.querySelector(el).style.display = 'none';
	}

	function createNewSelect(el, selectArray, optionsArray) {
		var _this2 = this;

		hideSelectEl(el);

		this.newSelect = document.createElement('DIV');
		this.newSelect.className = defaultClasses.newSelectClass;
		selectArray.forEach(function (item) {
			this.newSelect.setAttribute('data-' + item.name, item.value);
		}, this);

		this.button = document.createElement('A');
		this.button.className = defaultClasses.buttonClass;
		this.button.href = '/';

		this.text = document.createElement('SPAN');
		this.text.className = defaultClasses.textClass;

		this.icon = document.createElement('SPAN');
		this.icon.className = defaultClasses.iconClass;

		this.listWrapper = document.createElement('DIV');
		this.listWrapper.className = defaultClasses.listWrapperClass;

		this.list = document.createElement('UL');
		this.list.className = defaultClasses.listClass;

		var isSelectedAttr = false;
		optionsArray.forEach(function (item, i) {
			_this2.listItem = document.createElement('LI');
			_this2.listItem.className = defaultClasses.listItemClass;
			_this2.listItem.textContent = getOptionInnerText(el)[i];
			if (item.length) {
				item.forEach(function (attr) {
					if (attr.value === 'selected') {
						_this2.listItem.classList.add(defaultClasses.listItemSelectedClass);
						_this2.text.textContent = getOptionInnerText(el)[i];
						isSelectedAttr = true;
					}
					_this2.listItem.setAttribute('data-' + attr.name, attr.value);
				});
			} else {
				if (!i) {
					_this2.listItem.classList.add(defaultClasses.listItemSelectedClass);
					_this2.listItem.setAttribute('data-selected', 'selected');
					_this2.text.textContent = getOptionInnerText(el)[i];
				}
			}
			_this2.list.appendChild(_this2.listItem);
		});

		if (!isSelectedAttr) {
			this.list.querySelector('.' + defaultClasses.listItemClass).classList.add(defaultClasses.listItemSelectedClass);
			this.text.textContent = getOptionInnerText(el)[0];
		}

		this.button.appendChild(this.text);
		this.button.appendChild(this.icon);
		this.listWrapper.appendChild(this.list);
		this.newSelect.appendChild(this.button);
		this.newSelect.appendChild(this.listWrapper);

		// Add custom select to the DOM
		document.querySelector(el).parentElement.appendChild(this.newSelect);
	}

	function open() {
		var openedSelect = Array.prototype.slice.call(document.getElementsByClassName('select--open'));

		// If there are opened select elements - close theme if we open the new one.
		if (openedSelect.length) {
			openedSelect.forEach(function (item) {
				item.classList.remove('select--open');
			});
		}

		this.newSelect.classList.add('select--open');
		document.body.addEventListener('click', closeOnBodyClick);
	}

	function close() {
		this.newSelect.classList.remove('select--open');
		document.body.removeEventListener('click', closeOnBodyClick);
	}

	function closeOnBodyClick() {
		var openedSelect = document.getElementsByClassName('select--open')[0] ? document.getElementsByClassName('select--open')[0] : null;
		if (openedSelect) {
			openedSelect.classList.remove('select--open');
		}
		document.body.removeEventListener('click', closeOnBodyClick);
	}

	function getValue(el) {
		return el.getAttribute('data-value');
	}

	function doCallBack(fn, el) {
		fn({
			el: el,
			value: getValue(el)
		});
	}

	function changeSelectedAttrAndClass(e) {
		var newSelectedItem = e.target.closest('.select__item');
		var oldSelectedItem = newSelectedItem.parentElement.querySelector('.' + defaultClasses.listItemSelectedClass);

		// console.log(selectedItem)

		oldSelectedItem.classList.remove(defaultClasses.listItemSelectedClass);
		oldSelectedItem.removeAttribute('data-selected');
		newSelectedItem.classList.add(defaultClasses.listItemSelectedClass);
		newSelectedItem.setAttribute('data-selected', 'selected');
	}

	function onSelect(e) {
		close.call(this);
		if (this.callBack) {
			doCallBack.apply(this, [this.callBack, e.target.closest('.select__item')]);
		}
		changeSelectedAttrAndClass.call(this, e);
		this.text.textContent = e.target.closest('.select__item').textContent;
		this.select.value = e.target.closest('.select__item').getAttribute('data-value');
	}

	function initClickEvent() {
		var _this = this;

		this.newSelect.addEventListener('click', function (e) {
			e.preventDefault();
			e.stopPropagation();
			if (e.target.closest('.select')) {
				if (e.target.closest('.select').classList.contains('select--open')) {
					close.call(_this);
				} else {
					open.call(_this);
				}
			}
			if (e.target.closest('.select__item')) {
				onSelect.call(_this, e);
			}
		});
	}

	return Select;
});